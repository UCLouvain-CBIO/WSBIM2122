<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta property="og:title" content="Chapter 3 High throughput sequencing | Omics Data Analysis" />
<meta property="og:type" content="book" />

<meta property="og:description" content="Course material for the Omics Data Analysis (WSBIM2122) course at UCLouvain." />


<meta name="author" content="Laurent Gatto" />

<meta name="date" content="2024-10-30" />

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: { equationNumbers: { autoNumber: "AMS" } }
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<meta name="description" content="Course material for the Omics Data Analysis (WSBIM2122) course at UCLouvain.">

<title>Chapter 3 High throughput sequencing | Omics Data Analysis</title>

<link href="libs/tufte-css-2015.12.29/tufte.css" rel="stylesheet" />
<link href="libs/tufte-css-2015.12.29/envisioned.css" rel="stylesheet" />
<link href="libs/msmb-css-0/msmb.css" rel="stylesheet" />
<script>
function toggle_visibility(id1, id2) {
var e = document.getElementById(id1);
var f = document.getElementById(id2);

e.style.display = ((e.style.display!='none') ? 'none' : 'block');

if(f.classList.contains('fa-plus-square')) {
    f.classList.add('fa-minus-square')
    f.classList.remove('fa-plus-square')
} else {
    f.classList.add('fa-plus-square')
    f.classList.remove('fa-minus-square')
}

}
</script>
<script>
function copy_link(id) {
  var dummy = document.createElement('input'),
  text = window.location.href.split(/[?#]/)[0] + '#' + id;
  document.body.appendChild(dummy);
  dummy.value = text;
  dummy.select();
  document.execCommand('copy');
  document.body.removeChild(dummy);
  
  var tooltip = document.getElementById(id + '-tooltip');
  tooltip.innerHTML = 'Copied!';
}

function reset_tooltip(id) {
  var tooltip = document.getElementById(id);
  tooltip.innerHTML = 'Copy link';
}
</script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.33/datatables.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<script src="libs/plotly-binding-4.10.4/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }

code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />

</head>

<body>



<div class="row">
<div class="col-sm-12">
<div id="TOC">
<ul class="navbar">
<li class="msmb"><p class="title">Omics Data Analysis<p><p class="author">Laurent Gatto</p>
<li class="dropdown" style="float:right">
<a href="javascript:void(0)" class="dropbtn">&#x25BE; Chapters</a>
<div class="dropdown-content">
<a href="index.html" id="toc-preamble">Preamble</a>
<a href="sec-rmd.html" id="toc-sec-rmd"><span class="toc-section-number">1</span> R markdown</a>
<a href="sec-linmod.html" id="toc-sec-linmod"><span class="toc-section-number">2</span> Linear models</a>
<a id="active-page" href="sec-hts.html" id="toc-sec-hts"><span class="toc-section-number">3</span> High throughput sequencing</a><ul class="toc-sections">
<li class="toc"><a href="#rna-seq-library-preparation"> RNA-seq library preparation</a></li>
<li class="toc"><a href="#sequencing"> Sequencing</a></li>
<li class="toc"><a href="#fastq-files"> fastq files</a></li>
<li class="toc"><a href="#processing-pipeline"> Processing pipeline</a></li>
<li class="toc"><a href="#alignment"> Alignment</a></li>
<li class="toc"><a href="#counting"> Counting</a></li>
<li class="toc"><a href="#preparing-the-count-matrix"> Preparing the count matrix</a></li>
</ul>
<a href="sec-rnaseq.html" id="toc-sec-rnaseq"><span class="toc-section-number">4</span> Differential expression analysis</a>
<a href="sec-design.html" id="toc-sec-design"><span class="toc-section-number">5</span> More complex experimental design</a>
<a href="sec-gsea.html" id="toc-sec-gsea"><span class="toc-section-number">6</span> Enrichment analyses</a>
<a href="sec-ms.html" id="toc-sec-ms"><span class="toc-section-number">7</span> Mass spectrometry</a>
<a href="sec-prot.html" id="toc-sec-prot"><span class="toc-section-number">8</span> Quantitative proteomics data analysis</a>
<a href="sec-ccl.html" id="toc-sec-ccl"><span class="toc-section-number">9</span> Conclusions</a>
<a href="sec-cli.html" id="toc-sec-cli"><span class="toc-section-number">10</span> Annex: the shell</a>
<a href="sec-git.html" id="toc-sec-git"><span class="toc-section-number">11</span> Annex: Collaborating with Git and GitHub</a>
<a href="sec-info.html" id="toc-sec-info"><span class="toc-section-number">12</span> Course and session information</a>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="row">
<div class="col-sm-12">
<div id="sec-hts" class="section level1" number="3">
<h1>
<span class="header-section-number">Chapter 3</span> High throughput sequencing</h1>
<p><strong>Learning Objectives</strong></p>
<p>The aim of this chapter is to present high throughput sequencing by
going through one of its key applications: RNAseq. It is a highly
sensitive and accurate tool that has revolutionised the study of
transcriptomes. The objective is to give an overview of the
technology.</p>
<p><em>RNA Sequencing Data: Hitchhiker’s Guide to Expression
Analysis</em><span class="citation">(<label for="tufte-mn-5" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-5" class="margin-toggle">Van den Berge et al. 2019<span class="marginnote">Van den Berge, Koen, Katharina Hembach, Charlotte Soneson, Simone Tiberi, Lieven Clement, Michael Love, Rob Patro, and Mark Robinson. 2019. <span>“RNA Sequencing Data: Hitchhiker’s Guide to Expression Analysis.”</span> <em>Annual Review of Biomedical Data Science</em> 2 (July): 139–73. <a href="https://doi.org/10.1146/annurev-biodatasci-072018-021255">https://doi.org/10.1146/annurev-biodatasci-072018-021255</a>.</span>)</span> is an interesting review describing
RNA-seq technology and data analysis.</p>
<p>We will pass through the different steps starting from the library
preparation and the sequencing process. We will explore the resulting
fastq files and the downstream processing pipeline including quality
control, alignment and counting steps.</p>
<div id="rna-seq-library-preparation" class="section level2" number="3.1">
<h2>
<span class="header-section-number">3.1</span> RNA-seq library preparation<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('rna-seq-library-preparation')" onmouseout="reset_tooltip('rna-seq-library-preparation-tooltip')"><span class="tooltiptext" id="rna-seq-library-preparation-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The starting point of a RNAseq experiment is the cDNA library
preparation. RNA is first isolated from cells and purified to remove
ribosomal RNA which constitute the majority of total RNA. This can be
done by extracting poly(A) RNA or by depleting rRNA. Purified RNA is then
fragmented, reverse transcribed and adapters are ligated to both extremities
to allow for amplification and sequencing.</p>
<p><img src="figs/Unstranded_lib_prep.png" width="60%" style="display: block; margin: auto;"></p>
<div id="stranded-versus-unstranded-libraries" class="section level3" number="3.1.1">
<h3>
<span class="header-section-number">3.1.1</span> Stranded versus unstranded libraries<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('stranded-versus-unstranded-libraries')" onmouseout="reset_tooltip('stranded-versus-unstranded-libraries-tooltip')"><span class="tooltiptext" id="stranded-versus-unstranded-libraries-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The library preparation presented above corresponds to an <strong>unstranded protocol</strong>.</p>
<p>As both cDNA strands will be amplified for sequencing, about half of the
reads will be sequenced from the first cDNA strand, and half of the reads will
be sequenced from the second strand cDNA. But we won’t know which strand was
sequenced! So we lose the information about the orientation of the transcript.</p>
<p>This can be avoided by using a <strong>stranded protocol</strong>.
In this case, dUTPs are added during the 2nd strand cDNA synthesis and the
newly synthetized cDNA strand is degradated after the ligation step.
This allows to infer the transcript orientation because only the first cDNA strand
will be sequenced. Indeed, if the sequence of the read corresponds to the
the sense strand of DNA, it means that the gene was originally transcribed in a
sense orientation. On the contrary, if the read is complementary to the sense
strand of DNA, it means that it was originally transcribed in antisense.</p>
<p><img src="figs/stranded_vs_unstranded.png" width="100%" style="display: block; margin: auto;"></p>
<p>Strand-specificity leads to lower number of ambiguous reads.</p>
</div>
</div>
<div id="sequencing" class="section level2" number="3.2">
<h2>
<span class="header-section-number">3.2</span> Sequencing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('sequencing')" onmouseout="reset_tooltip('sequencing-tooltip')"><span class="tooltiptext" id="sequencing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<div id="se-vs-pe-sequencing" class="section level3" number="3.2.1">
<h3>
<span class="header-section-number">3.2.1</span> SE vs PE sequencing<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('se-vs-pe-sequencing')" onmouseout="reset_tooltip('se-vs-pe-sequencing-tooltip')"><span class="tooltiptext" id="se-vs-pe-sequencing-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Once the library is ready, molecules from the library are sequenced in
a high throughput manner to obtain short sequences from one end
(single-end sequencing) or both ends (pair-end sequencing). Single-end
sequencing is cheaper, but Paired-end sequencing improves the ability
to localise the fragment in the genome and resolve mapping close to
repeat regions, resulting in less multimapping reads.</p>
<p><img src="figs/SE_vs_PE.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div id="cluster-amplification" class="section level3" number="3.2.2">
<h3>
<span class="header-section-number">3.2.2</span> cluster amplification<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('cluster-amplification')" onmouseout="reset_tooltip('cluster-amplification-tooltip')"><span class="tooltiptext" id="cluster-amplification-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>The sequencing is done by a cluster amplification process.</p>
<p>The library preparation is hybridized to a flow cell coated with
immobilized oligonucleotides that serve as support to hold the DNA
strands in place during sequencing. The templates are copied from the
hybridized primers by 3’ extension using a high-fidelity DNA
polymerase. The original templates are denatured, leaving the copies
immobilized on the flow cell surface.</p>
<p>Immobilized DNA template copies are then amplified by bridge
amplification. The templates loop over to hybridize to adjacent
oligonucleotides. DNA polymerase copies the templates from the
hybridized oligonucleotides, forming dsDNA bridges, which are
denatured to form two ssDNA strands. These two strands loop over and
hybridize to adjacent oligonucleotides and are extended again to form
two new dsDNA loops. The process is repeated on each template by
cycles of denaturation and amplification to create millions of
individual, dense clonal clusters containing ~2,000 molecules.</p>
<p>Each cluster of dsDNA bridges is denatured, and the reverse strand is
removed by specific base cleavage, leaving the forward DNA strand. The
3’-ends of the DNA strands and flow cell-bound oligonucleotides are
blocked to prevent interference with the sequencing reaction. The
sequencing primer is hybridised to the Illumina adapter. Clusters are
ready for sequencing.</p>
<p><img src="figs/cluster_amplification.png" width="100%" style="display: block; margin: auto;"></p>
<p>The sequencing process is done by synthesis. A polymerase adds a
fluorescently tagged dNTP to the DNA strand (only one base is able to
be added per round due to the fluorophore acting as a blocking group,
but the blocking group is reversible). Each of the four bases has a
unique fluorophore, and after each round, the machine records which
base was added. The fluorophore is then washed away and the process is
repeated.</p>
<p>For a dynamic view of the cluster amplification process, watch the
<a href="https://www.youtube.com/watch?v=HMyCqWhwB8E">Illumina video</a>.</p>
</div>
</div>
<div id="fastq-files" class="section level2" number="3.3">
<h2>
<span class="header-section-number">3.3</span> fastq files<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('fastq-files')" onmouseout="reset_tooltip('fastq-files-tooltip')"><span class="tooltiptext" id="fastq-files-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The sequence data generated from the sequencer are received in text
files called <code>fastq</code> files. For a single-end run, one fastq file is
created for each sample. For a paired-end run, two separated fastq
files are generated, each containing sequences from one end.</p>
<p>What does a FASTQ file look like?</p>
<p><img src="figs/fastq_first_lines.png" width="100%" style="display: block; margin: auto;"></p>
<p>Each entry in a fastq file consists of 4 lines:</p>
<ul>
<li>A sequence identifier (by convention preceded by ‘@’) with
information about the sequencing run</li>
<li>The sequence</li>
<li>A delimiter, always starting by the sign ‘+’</li>
<li>The base call quality scores. These are Phred scores, encoded using
<a href="https://theasciicode.com.ar">ASCII characters</a> to represent the
numerical quality scores. Each character is assigned a quality
score between 0 and 40. Quality scores represent the probability
that the corresponding nucleotide call is correct.</li>
</ul>
<p><img src="figs/phred_score.png" width="100%" style="display: block; margin: auto;"></p>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>What do you think of the quality of the last sequence presented in the
fastq file above?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="processing-pipeline" class="section level2" number="3.4">
<h2>
<span class="header-section-number">3.4</span> Processing pipeline<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('processing-pipeline')" onmouseout="reset_tooltip('processing-pipeline-tooltip')"><span class="tooltiptext" id="processing-pipeline-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The raw reads from fastq files will need to pass through a different
tools to yield ultimately a count table, representing a snapshot of
individual gene expression levels. The execution of this set of tools
in a specified order is commonly referred to as a pipeline.</p>
<p><img src="figs/pipeline.png" width="40%" style="display: block; margin: auto;"></p>
<p>You can download the whole script that we will use to process the RNAseq data
by clicking
<a href="https://raw.githubusercontent.com/UCLouvain-CBIO/WSBIM2122/master/data/script_RNAseq_processing.sh">here</a></p>
<div id="quality-control" class="section level3" number="3.4.1">
<h3>
<span class="header-section-number">3.4.1</span> Quality control<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('quality-control')" onmouseout="reset_tooltip('quality-control-tooltip')"><span class="tooltiptext" id="quality-control-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h3>
<p>Of course, no one will analyse the sequences from the fastq file one
by one to check their quality… Rather, a software called
<a href="http://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a>
can be used. Then, another program such as
<a href="http://www.usadellab.org/cms/?page=trimmomatic">Trimmomatics</a> can
help to clean the reads.</p>
<ul>
<li><strong>FastQC</strong></li>
</ul>
<p><a href="http://www.bioinformatics.babraham.ac.uk/projects/fastqc/">FastQC</a>
allows to analyse different features of the reads and generates a
report that includes several diagnostic plots to highlight any problem
the data may have.</p>
<p>FastQC is run from the command line:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="sec-hts.html#cb83-1" tabindex="-1"></a><span class="sc">$</span> fastqc SampleName.fastq</span></code></pre></div>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Try to interpret the different plots of this
<a href="./OD01_10_1_fastqc.html">fastQC report</a>
from a real RNAseq fastq file.</p>
<p>Another report corresponding to <a href="https://www.bioinformatics.babraham.ac.uk/projects/fastqc/bad_sequence_fastqc.html">bad
quality</a>
data can be used as a point of comparison.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-5" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-5', 'sol-start-5')"></span>
</p>
<div id="sol-body-5" class="solution-body" style="display: none;">
<p><strong>1. Per base sequence quality</strong></p>
<p><img src="figs/fastqc_fig1.png" width="80%" style="display: block; margin: auto;"></p>
<p>This graph shows an overview of the range of quality values (Phred
scores) across all bases at each position. In this example, the sample
contains reads that are 150 bp long. For each position, a boxplot is
drawn with the median value, represented by the red line. The mean
quality is represented by the blue line. The background of the graph
divides the y-axis into very good quality scores (green), scores of
reasonable quality (orange), and reads of poor quality (red). Here
the quality of reads is very good.</p>
<p>This graph would for example represent low quality reads:</p>
<p><img src="figs/fastqc_bad_fig1.png" width="80%" style="display: block; margin: auto;"></p>
<p><strong>2. Per tile sequence quality</strong>:</p>
<p><img src="figs/fastqc_fig2.png" width="80%" style="display: block; margin: auto;"></p>
<p>Flowcells are divided into tiles. The graph allows to look at the
quality scores from each tile across the reads to see if there is a
loss in quality associated with one part of the flowcell. The plot
shows the deviation from the average quality for each tile. Cold
colours being positions where the quality was at or above the average
for that base in the run, and hotter colours indicate that a tile had
worse qualities than other tiles for that base. Low scores are often
found around the edges, but hot spots can also occur in the middle
(due to an air bubble for example), however these should represent
only a small percentage of the total sequences. In this example no
tile shows poor quality.</p>
<p>This graph would for example show some lower quality tiles:</p>
<p><img src="figs/fastqc_bad_fig2.png" width="80%" style="display: block; margin: auto;"></p>
<p><strong>3. Per sequence quality scores</strong></p>
<p><img src="figs/fastqc_fig3.png" width="80%" style="display: block; margin: auto;"></p>
<p>It represents a density plot of average quality per read. The
distribution of average read quality should show a tight peak in the
upper range of the plot. It could report a subset of sequences with
low quality values, however these should represent only a small
percentage of the total sequences.</p>
<p><strong>4. Per base sequence content</strong></p>
<p><img src="figs/fastqc_fig4.png" width="80%" style="display: block; margin: auto;"></p>
<p>It plots the proportion of each base position over all the
reads. Typically, we expect to see each base roughly 25% of the time
at each position so the lines in this plot should run parallel with
each other. Experience has shown that RNAseq libraries often have a
selection bias in around the first 12bp of each run. This is due to a
biased selection of random primers, but doesn’t represent any
individually biased sequences. This is a typical plot obtained for
RNAseq reads.</p>
<p>When Analysing DNA, the figure could look like this:</p>
<p><img src="figs/fastqc_bad_fig4.png" width="80%" style="display: block; margin: auto;"></p>
<p><strong>5. Per sequence GC content</strong></p>
<p><img src="figs/fastqc_fig5.png" width="80%" style="display: block; margin: auto;"></p>
<p>It gives the GC distribution across the reads.</p>
<p>This plot makes more sense for whole genome shotgun sequencing,
as the overall GC content should reflect the GC content of the underlying genome.
(Note that since the software doesn’t know the the GC content of the genome,
the theorical distribution is calculated from the observed data).</p>
<p>An unexpected distribution could indicate a contaminated library.</p>
<p>For RNA sequencing, this plot makes less sense, as over-represented sequences
might generate an unexpected distribution.</p>
<p><strong>6. Per base N content</strong></p>
<p><img src="figs/fastqc_fig6.png" width="80%" style="display: block; margin: auto;"></p>
<p>If a sequencer is unable to make a base call with sufficient
confidence then it will replace the conventional base call with an
‘N’. This graph plots the percent of times that ‘N’ occurs at a
position in all reads. If there was an increase at a particular
position, it could indicate that something went wrong during
sequencing.</p>
<p><strong>7. Sequence Length Distribution</strong></p>
<p><img src="figs/fastqc_fig7.png" width="80%" style="display: block; margin: auto;"></p>
<p>The distribution of sequence lengths of all reads in the file.
Here we see that most reads are 150 pb long but some reads are shorter.</p>
<p><strong>8. Sequence Duplication Levels</strong>:</p>
<p><img src="figs/fastqc_fig8.png" width="80%" style="display: block; margin: auto;"></p>
<p>It gives the distribution of duplicated reads. The blue line
corresponds to the percentage of duplicated reads among total number
of reads. The red line corresponds to the percentage of duplicated
reads among total number of distinct reads.</p>
<p>In a highly diverse library from whole genome shotgun sequencing, almost
all the reads are expected to be unique, appearing only 1
time in the sequence data. A high level of duplication could indicate
biased PCR enrichment, or presence of contaminant.</p>
<p>In contrast, in RNAseq, there will likely be some very highly abundant
transcripts for which it is expected to observe duplicated reads. Here
the data was flagged as ‘failed’ by FastQC even though duplication was
expected in this case.</p>
<p><strong>9. Overrepresented sequences</strong></p>
<p><img src="figs/fastqc_fig9.png" width="80%" style="display: block; margin: auto;"></p>
<p>FastQC lists here all of the sequence which make up more than 0.1% of
the total. Finding that a single sequence is highly overrepresented in
the set means that it is either highly biologically significant, or
that the library is biased or contaminated. Here it is of course not
relevant as it just corresponds to a sequence full of ‘N’.</p>
<p><strong>10. Adapter Content</strong></p>
<p><img src="figs/fastqc_fig10.png" width="80%" style="display: block; margin: auto;"></p>
<p>This graph indicates if and where adapter sequences occur in the reads.</p>
<p>If residual adapters were present we could see something like this:</p>
<p><img src="figs/fastqc_bad_fig10.png" width="80%" style="display: block; margin: auto;"></p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<ul>
<li><strong>Trimmomatics</strong></li>
</ul>
<p>FastQC gives a global vision the quality of the sample. If it is not
optimal, it is advisable to use
<a href="http://www.usadellab.org/cms/?page=trimmomatic">Trimmomatics</a>
software to filter poor quality reads and trim residual adapters.</p>
<p>Trimmomatics has a variety of options to clean the reads. Read the
<a href="http://www.usadellab.org/cms/uploads/supplementary/Trimmomatic/TrimmomaticManual_V0.32.pdf">manual</a>
for more information. However, a command for Trimmomatics could look
something like the command below. In this case it would perform
adapter removal, and perform a scan of the read with a 10-base wide
sliding window, cutting when the average quality per base drops below
20.</p>
<pre><code>$ java -jar trimmomatic.jar \
  PE \                                  # paired-end
  -threads 4 \                          # number of threads
  SampleName_1.fastq \                  # fastq file for fw reads
  SampleName_2.fastq  \                 # fastq file for rev reads
  SampleName_1_clean.fastq \            # clean fastq for fw reads
  SampleName_1_unpaired.fastq \         # fastq for unpaired remaining fw reads
  SampleName_2_clean.fastq \            # clean fastq for rev reads
  SampleName_2_unpaired.fastq \         # fastq for unpaired remaining rev reads
  ILLUMINACLIP:TruSeq3-PE.fa:2:30:10 \  # cut adapter from the read.
  SLIDINGWINDOW:10:20                   # sliding window trimming</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>How could you check that the trimming performed well?</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-6" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-6', 'sol-start-6')"></span>
</p>
<div id="sol-body-6" class="solution-body" style="display: none;">
<p>Once samples passed through Trimmomatics, they should perform better
on the quality tests run by FastQC. You could re-run FastQC on your
clean fastq files to see whether adapters were correctly removed and
if the per base sequence quality is higher after trimming…</p>
<pre><code>$ fastqc SampleName_1_clean.fastq</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
</div>
<div id="alignment" class="section level2" number="3.5">
<h2>
<span class="header-section-number">3.5</span> Alignment<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('alignment')" onmouseout="reset_tooltip('alignment-tooltip')"><span class="tooltiptext" id="alignment-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p><img src="figs/pipeline_mapping.png" width="20%" style="display: block; margin: auto;"></p>
<p>Next step is to map the reads to determine where in the genome the
reads originated from. Many different aligners are available such as
<a href="https://ccb.jhu.edu/software/hisat2/manual.shtml">HISAT2</a>,
<a href="https://github.com/alexdobin/STAR">STAR</a>,
<a href="http://bio-bwa.sourceforge.net">BWA</a>,
<a href="https://combine-lab.github.io/salmon/">Salmon</a>,
<a href="https://sourceforge.net/projects/subread/">Subread</a>… There is no
gold standard, but some tools are better suited for particular NGS
analyses <span class="citation">(<label for="tufte-mn-6" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-6" class="margin-toggle">Giacomo et al. 2017<span class="marginnote">Giacomo, B, K E Hayer, E J Kim, B Di Camillo, G A FitzGerald, and G R Grant. 2017. <span>“Simulation-Based Comprehensive Benchmarking of RNA-Seq Aligners.”</span> <em>Nature Methods</em> 2 (14): 135. <a href="https://doi.org/10.1038/nmeth.4106">https://doi.org/10.1038/nmeth.4106</a>.</span>)</span>… In the case of RNAseq, it is important to
use an aligner able to handle spliced reads.</p>
<p><img src="figs/spliced_alignment.png" width="100%" style="display: block; margin: auto;"></p>
<p>Here we show an example of what the command could look like when using
<a href="http://daehwankimlab.github.io/hisat2/">HISAT2</a> aligner,
launched with default parameters. In this basic configuration,
mandatory parameters are of course the fastq file(s) and the sequence
of the genome on which the reads have to be aligned. In practical, the
genome’s sequence is not given as it is but in an indexed form
<label for="tufte-sn-4" class="margin-toggle sidenote-number">4</label><input type="checkbox" id="tufte-sn-4" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">4</span> Genome indexing allows the aligner to quickly find
potential alignment sites for query sequences in a genome, which saves
considerable time during alignment. Frequently used genome (human,
mouse, rat…) already have indexed versions that can be downloaded
directly. When working with another reference genome, a specific
indexed genome has to be built.</span>. Of course many of other parameters can be fine
tuned (see the
<a href="http://daehwankimlab.github.io/hisat2/manual/">manual</a> for more
details). The alignment output file data is a <code>sam</code> file (see below).</p>
<pre><code>$ hisat2 \
  -p 6 \                        # number of threads
  -x genome_index \             # index for the reference genome
  -1 SampleName_1_clean.fastq \ # clean fastq_file for fw reads
  -2 SampleName_2_clean.fastq \ # clean fastq_file for rev reads
  -S SampleName.sam             # sam file name</code></pre>
<p>It is recommended to pay attention to the HISAT2 report to check the
alignment rate. For a PE-end alignment it could look like this:</p>
<p><img src="figs/hisat2_report.png" width="100%" style="display: block; margin: auto;"></p>
<p><strong>SAM format</strong></p>
<p>The <a href="https://genome.sph.umich.edu/wiki/SAM">SAM</a> format is a generic
format for storing large nucleotide sequence alignments.
In a SAM file, each entry gives the alignment information for a single read.
Each entry has 11 mandatories fields for essential mapping information
and a variable number of other fields for aligner specific information.
An example of few entries from a SAM
file is displayed below.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="sec-hts.html#cb87-1" tabindex="-1"></a><span class="fu">head</span> wsbim2122_data/RNAseq_pipeline/example.sam</span></code></pre></div>
<pre><code>## DRR016707.26395247   147 1   19626495    60  101M    =   19626490    -106    GTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAAGTTGTAAGG   DDDDDDDDDDDDDEEEEEEEFFFFFFHCHHHJJJHHJJJJJJJJJJJJIHFJJIHJJJJJJJJJJJJJJJJJJJJJJJJJJJJIJJJJHHHHHFFFFFCCC   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.26395247   99  1   19626490    60  101M    =   19626495    106 CTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAAGTTG   CCCFFFFFHHHHHJIJJJJIJJJJJJJJJJIJJJJJJJJJJJJJJJHHIHIJJJIJJHIJJJIIIIIIJGIJJJJDHJJJHHHHHHHFFFFFFEDACEEDD   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.34969377   163 1   19626487    60  101M    =   19626493    107 ATTCTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAAG   CC@FFFFFHFHFFHGGJCIFJGHIIIIGIIIIJIIJJJIGIIIIIIGII?:BFHGHIIIIGEHHHGIIDGGH@GGIGHJGHHHHCEHDEFDDFFEEECCEC   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.34969377   83  1   19626493    60  101M    =   19626487    -107    CTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAAGTTGTAA   CDDDDDDDDDDDDECEEEEEFFFFD?=HHHHGIIGEGIGIIIHIGDIHHGGGIIHGHIIIIGIIIGIGEIIGGGIIIIGIIIIGHDIIFHHHHFFBDD?C@   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.42561021   161 1   19626495    60  100M1S  =   19626494    0   GTAACAATGTTATCAGTAATGCTTTAAACTAAAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAAGTTGTAAGA   ?8?B1:BDD,,2&lt;:C&lt;2A&lt;&lt;,+A?CBFFAE&lt;+&lt;+2A?EEBD99:D&lt;*?B:*:D9B:DD/BDED@)=8=B;@=)).=(=@;7A)7.==&gt;;3);@AAA&gt;A@3;   AS:i:-8 XN:i:0  XM:i:2  XO:i:0  XG:i:0  NM:i:2  MD:Z:30C0C68    YT:Z:UP NH:i:1
## DRR016707.42561021   81  1   19626494    60  101M    =   19626495    0   TGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGACACCAAGTCTGTTTCTTGTTTTGTATTTTCGCTCTGGAAGTTGTAAG   (9(??==3??&gt;==;5(55((6.((9&gt;;..;67&gt;)&gt;).5(A;;&gt;=/))8.=&gt;9)((?AB?92=00*;=::1)=:3=74=A7&lt;)0&lt;+&lt;AAAB?=&lt;+4AA&lt;;==   AS:i:-5 ZS:i:-19    XN:i:0  XM:i:2  XO:i:0  XG:i:0  NM:i:2  MD:Z:54A29T16   YT:Z:UP NH:i:1
## DRR016707.43465443   163 1   19626483    60  101M    =   19626486    104 TGCCATTCTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTG   B@@FAFFFHHHHHHIIIIJJJHJJIJJIIJJJJJJJFJJJJJJJJJJJJJHIJFHJJIJJJIJJIIJIJJHIHHIIIJJJJJHEHHHFEFFFFFEDEEEEE   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:-1 YT:Z:CP NH:i:1
## DRR016707.43465443   83  1   19626486    60  100M1S  =   19626483    -104    CATTCTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGGAG   DDDDDDCDDDDCCDEEEEDFFFFFDBHHHHHGJJGHDJIJJIGIHJGGJJJJJJJJJJJJJHG?JJJJJJJJJJJIIJJJJIJJJJJIGHGHHFFFFFCCC   AS:i:-1 ZS:i:-12    XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:100    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.64407509   147 1   19626484    60  101M    =   19626484    -101    GCCATTCTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGG   DDDDDCDDDDDDEEDEEEEFFFFFFHHHHHHJJIJIGHFIHJJJIHFIHHFJJJJJIJJJJJJJIHJJJJJIJJJJJJJJJJJJJJJJHHHHHFFFFFBB@   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1
## DRR016707.64407509   99  1   19626484    60  101M    =   19626484    -101    GCCATTCTTCTGTAACAATGTTATCAGTAATGCTTTAAACTCCAGCACCTGGTTATGCATTTGAAACCAAGTCTGTTTCTTGTTTTGTATTTTCTCTCTGG   CCCFFFFFHHHHHJJJJJJJIJJJJJJJJJJJJJJJJJJJJJIJJJJJJIJJDGIJJJJJJJJCGIJJJIIHHJJJHHIJJJHHHHHDFFFFFFEEEEEED   AS:i:0  XN:i:0  XM:i:0  XO:i:0  XG:i:0  NM:i:0  MD:Z:101    YS:i:0  YT:Z:CP NH:i:1</code></pre>
<p>Field 1: Sequence ID</p>
<p>Field 2: <a href="https://broadinstitute.github.io/picard/explain-flags.html">SAM Flag</a>. It gives information about
the read (is it paired, aligned, is the mate read properly aligned…)</p>
<p>Field 3: Chromosome where alignment occurs</p>
<p>Field 4: Position of alignment</p>
<p>Field 5: Mapping quality score (read uniquely mapped (60), multiply mapped (1) or unmapped (0))</p>
<p>Field 6: <a href="https://timd.one/blog/genomics/cigar.php">CIGAR</a>
string. It is a representation of alignment indicating positions of match/mismatch/deletion/insertion
compared to the reference.</p>
<p>Field 7: Reference name of the mate (Set to ‘=’ if the mate’s reference sequence is the same as this alignment’s)</p>
<p>Field 8: Position of mate</p>
<p>Field 9: Inferred fragment length</p>
<p>Field 10: Read sequence (reverse-complemented if aligned to the reverse strand)</p>
<p>Field 11: Base quality (Phred score)</p>
<p>Field 12: Optional. See <a href="http://daehwankimlab.github.io/hisat2/manual/">hisat2 manual</a> for more information.</p>
<p><strong>BAM format</strong></p>
<p>The BAM file is a compressed binary version of SAM file. SAM files can be
easily converted into BAM files using <a href="http://www.htslib.org%20software">samtools</a>, and it is sometimes mandatory to sort the SAM/BAM by
chromosomal coordinates for downstream applications.</p>
<pre><code>samtools view -Sb SampleName.sam | samtools sort &gt; SampleName.bam</code></pre>
<p><strong>Alignment visualisation</strong></p>
<p>Alignements described in BAM files can easily be viewed using
<a href="https://software.broadinstitute.org/software/igv/">IGV</a> (Integrative Genomics Viewer),
a very useful interactive tool for the visual exploration of genomic data.</p>
<p>Visualising the alignments is not part of the processing pipeline
but sometimes it can be useful..</p>
<p><img src="figs/pipeline_IGV.png" width="60%" style="display: block; margin: auto;"></p>
<p>IGV requires that BAM files have an associated index file<label for="tufte-sn-5" class="margin-toggle sidenote-number">5</label><input type="checkbox" id="tufte-sn-5" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">5</span> Indexing a BAM file allows IGV to quickly extract alignments overlapping
particular genomic regions</span>.
Samtools can be used to index the BAM file. The following command would create
the indexed SampleName.bam.bai file.</p>
<pre><code>samtools index SampleName.bam</code></pre>
<p>Bam file can be loaded in IGV<label for="tufte-sn-6" class="margin-toggle sidenote-number">6</label><input type="checkbox" id="tufte-sn-6" class="margin-toggle"><span class="sidenote"><span class="sidenote-number">6</span> Note that the index file must reside in the same directory as the bam
file that it indexes, and it must have the same basename</span>.
Below is an example of visualisation of a bam file using IGV, focusing on CDKN1A gene.</p>
<p><img src="figs/IGV.png" width="100%" style="display: block; margin: auto;"></p>
<p>Loading a BAM file creates 3 associated tracks:</p>
<ul>
<li><p>Coverage Track to view depth of coverage</p></li>
<li><p>Splice Junction Track which provides an alternative view of reads spanning splice junctions</p></li>
<li><p>Alignment Track to view individual aligned reads</p></li>
</ul>
</div>
<div id="counting" class="section level2" number="3.6">
<h2>
<span class="header-section-number">3.6</span> Counting<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('counting')" onmouseout="reset_tooltip('counting-tooltip')"><span class="tooltiptext" id="counting-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p><img src="figs/pipeline_counting.png" width="20%" style="display: block; margin: auto;"></p>
<p>Now comes the quantification step. It can be performed with several
tools such as <a href="https://pypi.org/project/HTSeq/">htseq-count</a> or
<a href="http://bioinf.wehi.edu.au/featureCounts/">FeatureCounts</a>. We will
describe the latter as it runs much faster. It was developed for
counting reads to genomic features such as genes, exons, promoters and
genomic bins. FeatureCounts takes as input SAM/BAM files and an
annotation file (such as a gtf file) containing chromosomal
coordinates of features.</p>
<p>The Gene Transfer Format (GTF) is a widely used format for storing
gene annotations. Human and mouse GTF files can be downloaded easily
from <a href="http://www.ensembl.org/info/data/ftp/index.html">Ensembl</a> or
from the <a href="https://www.gencodegenes.org/human/">UCSC table
browser</a>. The first few lines of
gtf annotation file for human genome assembly GRCh38 look like this:</p>
<p><img src="figs/gtf_example.png" width="100%" style="display: block; margin: auto;"></p>
<p>FeatureCounts will count the number of uniquely mapped reads assigned
to features (e.g. an exon) or meta-features (e.g. a gene) of the gtf
file. When summarizing reads at gene level, read counts obtained for
exons belonging to the same gene will be added up to yield the read
count for the corresponding gene. Note that an exon-spanning read
will be counted only once for the corresponding gene even if it
overlaps with more than one exon.</p>
<p><img src="figs/featurecount_metafeature.png" width="100%" style="display: block; margin: auto;"></p>
<p>FeatureCounts could be launched with the following command. As usual,
many of other parameters can be fine-tuned (see the
<a href="http://manpages.ubuntu.com/manpages/bionic/man1/featureCounts.1.html">manual</a>
for more details).</p>
<pre><code>featureCounts \
-p \                        # paired-end
--countReadPairs \          # fragments counted instead of reads
-a annotations.gtf \        # name of the annotation file
-t exon \                   # feature type in GTF annotation
-g gene_id \                # Meta-features used in GTF annotation
-s 0 \                      # strand-specificity
-o SampleName_counts.tsv \  # Name of the output file
SampleName.bam              # bam file</code></pre>
<p>Here is an example of featurecounts output file. The last column gives
the raw counts of each gene in that sample.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="sec-hts.html#cb92-1" tabindex="-1"></a>counts_result <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="at">file =</span> <span class="st">"wsbim2122_data/count_data/sample1_counts.tsv.gz"</span>)</span>
<span id="cb92-2"><a href="sec-hts.html#cb92-2" tabindex="-1"></a><span class="fu">datatable</span>(<span class="fu">head</span>(counts_result))</span></code></pre></div>
<div class="datatables html-widget html-fill-item" id="htmlwidget-9de02a3ebad8d64efe56" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9de02a3ebad8d64efe56">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6"],["ENSG00000223972","ENSG00000227232","ENSG00000278267","ENSG00000243485","ENSG00000284332","ENSG00000237613"],["1;1;1;1;1;1;1;1;1","1;1;1;1;1;1;1;1;1;1;1","1","1;1;1;1;1","1","1;1;1;1;1"],["11869;12010;12179;12613;12613;12975;13221;13221;13453","14404;15005;15796;16607;16858;17233;17606;17915;18268;24738;29534","17369","29554;30267;30564;30976;30976","30366","34554;35245;35277;35721;35721"],["12227;12057;12227;12721;12697;13052;13374;14409;13670","14501;15038;15947;16765;17055;17368;17742;18061;18366;24891;29570","17436","30039;30667;30667;31109;31097","30503","35174;35481;35481;36073;36081"],["+;+;+;+;+;+;+;+;+","-;-;-;-;-;-;-;-;-;-;-","-","+;+;+;+;+","+","-;-;-;-;-"],[1735,1351,68,1021,138,1219],[0,14,8,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Geneid<\/th>\n      <th>Chr<\/th>\n      <th>Start<\/th>\n      <th>End<\/th>\n      <th>Strand<\/th>\n      <th>Length<\/th>\n      <th>../processed_data/bam/sample1.bam<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[6,7]},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"Geneid","targets":1},{"name":"Chr","targets":2},{"name":"Start","targets":3},{"name":"End","targets":4},{"name":"Strand","targets":5},{"name":"Length","targets":6},{"name":"../processed_data/bam/sample1.bam","targets":7}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Inspect the count table.</p>
<ol style="list-style-type: decimal">
<li><p>How many genes are tested ?</p></li>
<li><p>How many reads were assigned to genes?</p></li>
<li><p>Inspect the counts. What is the maximum value? How many genes have zero counts ?</p></li>
<li><p>Plot the distribution of counts. How does it look like?</p></li>
</ol>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-7" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-7', 'sol-start-7')"></span>
</p>
<div id="sol-body-7" class="solution-body" style="display: none;">
<p>Inspect the count table.</p>
<ol style="list-style-type: decimal">
<li>How many genes are tested ?</li>
</ol>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb93-1"><a href="sec-hts.html#cb93-1" tabindex="-1"></a><span class="fu">nrow</span>(counts_result)</span></code></pre></div>
<pre><code>## [1] 58735</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>How many reads were assigned to genes?</li>
</ol>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="sec-hts.html#cb95-1" tabindex="-1"></a>counts_result <span class="ot">&lt;-</span> counts_result <span class="sc">%&gt;%</span></span>
<span id="cb95-2"><a href="sec-hts.html#cb95-2" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">counts =</span> <span class="st">"../processed_data/bam/sample1.bam"</span>)</span>
<span id="cb95-3"><a href="sec-hts.html#cb95-3" tabindex="-1"></a><span class="fu">sum</span>(counts_result<span class="sc">$</span>counts)</span></code></pre></div>
<pre><code>## [1] 10527830</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Inspect the counts. What is the maximum value? How many genes have zero counts ?</li>
</ol>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="sec-hts.html#cb97-1" tabindex="-1"></a><span class="fu">summary</span>(counts_result<span class="sc">$</span>counts)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
##      0.0      0.0      0.0    179.2      6.0 143371.0</code></pre>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="sec-hts.html#cb99-1" tabindex="-1"></a>counts_result <span class="sc">%&gt;%</span></span>
<span id="cb99-2"><a href="sec-hts.html#cb99-2" tabindex="-1"></a>  <span class="fu">filter</span>(counts <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb99-3"><a href="sec-hts.html#cb99-3" tabindex="-1"></a>  <span class="fu">nrow</span>()</span></code></pre></div>
<pre><code>## [1] 36035</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Plot the distribution of counts. How does it look like?</li>
</ol>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="sec-hts.html#cb101-1" tabindex="-1"></a>counts_result <span class="sc">%&gt;%</span></span>
<span id="cb101-2"><a href="sec-hts.html#cb101-2" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log2</span>(counts <span class="sc">+</span> <span class="dv">1</span>))) <span class="sc">+</span></span>
<span id="cb101-3"><a href="sec-hts.html#cb101-3" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>)</span></code></pre></div>
<p><img src="WSBIM2122_files/figure-html/unnamed-chunk-59-1.png" width="672"></p>
<p>Note that a “pseudo-count” was added before the log2 transformation of the counts,
to avoid elimination of counts equal to zero.</p>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
</div>
<div id="preparing-the-count-matrix" class="section level2" number="3.7">
<h2>
<span class="header-section-number">3.7</span> Preparing the count matrix<div class="tooltip"><button class="internal-link-btn" onclick="copy_link('preparing-the-count-matrix')" onmouseout="reset_tooltip('preparing-the-count-matrix-tooltip')"><span class="tooltiptext" id="preparing-the-count-matrix-tooltip">Copy link</span><i class="fa fa-link"></i></button></div>
</h2>
<p>The aim of an RNAseq experiment is often to compare different types of
cells, or to compare treated cells to control cells, to see if some
genes are up- or down- regulated.</p>
<p>Once fastq files from each sample have been processed into raw counts,
results can be merged in a single count matrix, were each column represents a sample,
and each line represents a gene. This count matrix will be the starting point of a
differential expression analysis.</p>
<pre><code>##                 sample1 sample2 sample3 sample4 sample5 sample6
## ENSG00000223972       0       0       0       0       0       1
## ENSG00000227232      14      28      17      40      16      13
## ENSG00000278267       8       4       3       1       1       6
## ENSG00000243485       0       0       0       0       0       0
## ENSG00000284332       0       0       0       0       0       0
## ENSG00000237613       0       0       0       0       0       0</code></pre>
<div class="question">
<p class="question-begin">
► Question
</p>
<div class="question-body">
<p>Imagine you had initially 6 samples (3 control and 3 treated samples) that you have
processed independently giving the 6 counts files generated by FeatureCounts located
in the folder <code>wsbim_data/count_data/</code>. Use these files to create a count matrix.</p>
<p class="question-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<div class="msmb-solution">
<p class="solution-begin">
► Solution<span id="sol-start-8" class="fa fa-plus-square solution-icon clickable" onclick="toggle_visibility('sol-body-8', 'sol-start-8')"></span>
</p>
<div id="sol-body-8" class="solution-body" style="display: none;">
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="sec-hts.html#cb103-1" tabindex="-1"></a>samples <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">"wsbim2122_data/count_data"</span>,</span>
<span id="cb103-2"><a href="sec-hts.html#cb103-2" tabindex="-1"></a>                      <span class="at">pattern =</span> <span class="st">"*tsv.gz"</span>,</span>
<span id="cb103-3"><a href="sec-hts.html#cb103-3" tabindex="-1"></a>                      <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb103-4"><a href="sec-hts.html#cb103-4" tabindex="-1"></a>samples</span></code></pre></div>
<pre><code>## [1] "wsbim2122_data/count_data/sample1_counts.tsv.gz"
## [2] "wsbim2122_data/count_data/sample2_counts.tsv.gz"
## [3] "wsbim2122_data/count_data/sample3_counts.tsv.gz"
## [4] "wsbim2122_data/count_data/sample4_counts.tsv.gz"
## [5] "wsbim2122_data/count_data/sample5_counts.tsv.gz"
## [6] "wsbim2122_data/count_data/sample6_counts.tsv.gz"</code></pre>
<div class="sourceCode" id="cb105"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb105-1"><a href="sec-hts.html#cb105-1" tabindex="-1"></a>counts <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(<span class="at">file =</span> samples[<span class="dv">1</span>]) <span class="sc">%&gt;%</span></span>
<span id="cb105-2"><a href="sec-hts.html#cb105-2" tabindex="-1"></a>    <span class="fu">select</span>(Geneid, <span class="fu">ends_with</span>(<span class="st">'.bam'</span>))</span>
<span id="cb105-3"><a href="sec-hts.html#cb105-3" tabindex="-1"></a></span>
<span id="cb105-4"><a href="sec-hts.html#cb105-4" tabindex="-1"></a><span class="cf">for</span> (sample <span class="cf">in</span> samples[<span class="sc">-</span><span class="dv">1</span>]){</span>
<span id="cb105-5"><a href="sec-hts.html#cb105-5" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">read_tsv</span>(sample) <span class="sc">%&gt;%</span></span>
<span id="cb105-6"><a href="sec-hts.html#cb105-6" tabindex="-1"></a>    <span class="fu">select</span>(<span class="fu">ends_with</span>(<span class="st">'.bam'</span>))</span>
<span id="cb105-7"><a href="sec-hts.html#cb105-7" tabindex="-1"></a>  counts <span class="ot">&lt;-</span> <span class="fu">cbind</span>(counts, tmp)</span>
<span id="cb105-8"><a href="sec-hts.html#cb105-8" tabindex="-1"></a>}</span>
<span id="cb105-9"><a href="sec-hts.html#cb105-9" tabindex="-1"></a></span>
<span id="cb105-10"><a href="sec-hts.html#cb105-10" tabindex="-1"></a><span class="fu">names</span>(counts) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="at">pattern =</span> <span class="st">".bam$"</span>, <span class="st">''</span>, <span class="fu">names</span>(counts))</span>
<span id="cb105-11"><a href="sec-hts.html#cb105-11" tabindex="-1"></a><span class="fu">names</span>(counts) <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="at">pattern =</span> <span class="st">"../processed_data/bam/"</span>, <span class="st">''</span>, <span class="fu">names</span>(counts))</span>
<span id="cb105-12"><a href="sec-hts.html#cb105-12" tabindex="-1"></a><span class="fu">head</span>(counts)</span></code></pre></div>
<pre><code>##            Geneid sample1 sample2 sample3 sample4 sample5 sample6
## 1 ENSG00000223972       0       0       0       0       0       1
## 2 ENSG00000227232      14      28      17      40      16      13
## 3 ENSG00000278267       8       4       3       1       1       6
## 4 ENSG00000243485       0       0       0       0       0       0
## 5 ENSG00000284332       0       0       0       0       0       0
## 6 ENSG00000237613       0       0       0       0       0       0</code></pre>
<p class="solution-end">
<span class="fa fa-square-o solution-icon"></span>
</p>
</div>
</div>
<p>As differential expression analysis addresses relatively complex statistical concepts,
it will be covered in the next chapter.</p>

</div>
</div>
<p style="text-align: center;">
<a href="sec-linmod.html"><button class="btn btn-default">Previous</button></a>
<a href="sec-rnaseq.html"><button class="btn btn-default">Next</button></a>
</p>
<p class="build-date">Page built: 
2024-10-30
 using 
R version 4.4.1 (2024-06-14)
</p>
</div>
</div>



</body>
</html>
